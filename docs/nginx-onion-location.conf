# Nginx Configuration for Onion-Location Header
# This configuration enables automatic .onion service discovery in Tor Browser
#
# When users visit your clearnet site through Tor Browser, they will see a purple
# onion icon in the address bar, allowing them to seamlessly switch to your .onion service.
#
# Reference: https://community.torproject.org/onion-services/advanced/onion-location/

# Basic configuration - Always add Onion-Location header
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;

    # SSL configuration
    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # Add Onion-Location header to all responses
    # Replace with your actual .onion address
    add_header Onion-Location "http://your-onion-address.onion$request_uri" always;

    location / {
        root /var/www/html;
        index index.html;
    }
}

# Advanced configuration - Only add header when accessed via Tor
# This approach detects Tor exit nodes and only shows the .onion alternative to Tor users
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;

    # SSL configuration
    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # Set a default variable for onion location
    set $onion_location "";

    # Detect if request is coming from Tor exit node
    # You would need to maintain a list of Tor exit node IPs
    # Or use a GeoIP database that identifies Tor nodes
    if ($http_x_forwarded_for ~* "tor-exit-node-pattern") {
        set $onion_location "http://your-onion-address.onion$request_uri";
    }

    # Add header only if onion_location is set
    add_header Onion-Location $onion_location always;

    location / {
        root /var/www/html;
        index index.html;
    }
}

# Configuration with HTTPS .onion (requires v3 onion service with valid certificate)
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;

    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # Use HTTPS if your .onion service has a valid certificate
    # Most .onion services use HTTP, but HTTPS is possible with valid certs
    add_header Onion-Location "https://your-onion-address.onion$request_uri" always;

    location / {
        root /var/www/html;
        index index.html;
    }
}

# Multi-language configuration - Different .onion per language
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;

    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # Default onion address
    set $onion_address "your-default-onion.onion";

    # Override for specific language paths
    location /es/ {
        set $onion_address "your-spanish-onion.onion";
        add_header Onion-Location "http://$onion_address$request_uri" always;
        root /var/www/html;
    }

    location /fr/ {
        set $onion_address "your-french-onion.onion";
        add_header Onion-Location "http://$onion_address$request_uri" always;
        root /var/www/html;
    }

    # Default location
    location / {
        add_header Onion-Location "http://$onion_address$request_uri" always;
        root /var/www/html;
    }
}

# Configuration for proxied applications
server {
    listen 443 ssl http2;
    server_name example.com www.example.com;

    ssl_certificate /path/to/ssl/cert.pem;
    ssl_certificate_key /path/to/ssl/key.pem;

    # Add Onion-Location for proxied apps (e.g., Node.js, Python)
    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Add Onion-Location header to proxied responses
        add_header Onion-Location "http://your-onion-address.onion$request_uri" always;
    }
}

# Security considerations
# 1. Always use "always" flag with add_header to ensure header is added even on error responses
# 2. Include $request_uri to preserve the full path when switching to .onion
# 3. Use HTTP for .onion unless you have a valid certificate for HTTPS
# 4. Ensure your .onion service is stable and accessible before advertising it
# 5. Test thoroughly with Tor Browser before deploying to production

# Best practices
# - Keep .onion address in a variable for easy updates
# - Use the same TLS configuration for both clearnet and .onion (if using HTTPS)
# - Monitor both clearnet and .onion service uptime
# - Document the .onion address in multiple places (headers, footer, meta tags)
